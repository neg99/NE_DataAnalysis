\chapter{Лекция 3. Линейные фильтры}

\section{Линейный фильтр, импульсная характеристика, причинный фильтр, FIR}

Очень часто встречающимся методом анализа временных рядов является сглаживание ряда с помощью скользящего среднего (усреднения значений ряда по скользящим отрезкам ряда). В виде формул это выглядит, например, так:
$y_n = \sum_{i=-r}^{r} x_{n-i} /M$, где $M=2r+1$ (картинка). Видим, что результат является линейной комбинацией значений ряда. Это пример линейного фильтра с коэффициентами $1/M$. Оказывается, что есть теория, связанная с линейными фильтрами, которая позволяет предсказывать результат на основе коэффициентов фильтров, в частности, с точки зрения частотного содержания результата фильтрации, который рассматривался на предыдущей лекции (периодограммы).

Итак, введем определения.

Рассмотрим бесконечный временной ряд $\mathsf{X}^{\infty} = (\dots, x_{-1}, x_{0}, x_{1}, \dots)$.
Тогда:
\begin{itemize}
	\item $y_{j}=(\Phi(\mathbf{x}^{N}))_{j}=\sum_{i=-\infty}^{\infty} h_{i} x_{j-i}$ --- линейный фильтр;
	\item Набор коэффициентов $\{h_i\}$ --- импульсная характеристика фильтра (impulse response)
	\item Если набор коэффициентов $\{h_i: h_i \neq 0\}$ конечен, то импульсная характеристика называется конечной (КИХ), или finite impulse response (FIR). Тогда $y_{j} = (\Phi(\mathbf{x}^{N}))_{j}=\sum_{i=-r_{1}}^{r_{2}} h_{i} x_{j-i}$. Иначе фильтр называется БИХ (IIR). Примером  фильтра БИХ является фильтр с экспоненциально убывающими коэффициентами. Мы будем рассматривать КИХ фильтры.
	\item Для прогноза очень важно, чтобы фильтр не заглядывал в будущее. Поэтому отдельно выделяют фильтры $y_{j}=(\Phi(\mathbf{x}^{N}))_{j}=\sum_{i=0}^{r_2} h_{i} x_{j-i}$ --- причинный фильтр (casual), смотрим только в прошлое. На этом примере видно, что, на самом деле, фильтр определяется не только коэффициентами, но и тем, с какой временной точкой соотносится результат фильтра.
\end{itemize}

На практике мы никогда не располагаем бесконечным рядом. Поэтому, при рассмотрении ряда конечной длины $\mathsf{X}_N = (x_1, \dots, x_N)$ можно сделать, например, следующее: вкладываем его в бесконечную последовательность $\mathbf{x}^{\infty} = (\dots, 0, \dots, 0, x_1, \dots, x_N, 0, \dots)$ и рассматриваем её как бесконечный временной ряд. //Вообще, много чего делается, это для примера, который подходит для временного ряда  с нулевым средним.

\section{Характеристики фильтра через его воздействие на $\cos(2 \pi \omega n)$ (или на комплексную экспоненту) – АЧХ, ФЧХ}

Напоминание: $y_{j}=(\Phi(\mathbf{x}^{N}))_{j}=\sum_{i=-\infty}^{\infty} h_{i} x_{j-i}$ --- линейный фильтр. Тогда:
\begin{itemize}
	\item $H_{\Phi}(z)=\sum_{i} h_{i} z^{-i}$ --- передаточная функция (transfer function);
	\item $\left|H_{\Phi}(e^{i 2 \pi \omega})\right|=A_{\Phi}(\omega)$ --- амплитудно-частотная характеристика фильтра (АЧХ);
	\item $\phi_{\Phi}(\omega) = \mathrm{Arg}(H_{\Phi}(e^{i 2 \pi \omega}))$ --- фазово-частотная характеристика (ФЧХ).
\end{itemize}

Выглядит все очень страшно, однако нам достаточно всего одного простого факта:

Пусть исходный временной ряд имеет общих член $x_j = \cos(2\pi \omega j)$. Тогда:
$$ y_j = (\Phi(\mathbf{x}^N))_{j}=A_{\Phi}(\omega) \cos \left(2 \pi \omega j+\phi_{\Phi}(\omega)\right).$$
Так как линейный фильтр --- линейное преобразование, то фильтр, примененный к сумме некоторых слагаемых (например, гармоник), равен сумме фильтров, примененных к каждому слагаемому по-отдельности.

Тут должно стать понятно, куда мы клоним: теперь мы знаем, как действует фильтр на разложение Фурье временного ряда.

Мы будем делать акцент на АЧХ, которая показывает, как меняется амплитуда в зависимости от частоты.

Вот представьте, что нам нужно сгладить ряд (сгладить = убрать быстрые колебания = оставить только колебания с низким частотами). Мы обсуждали, что гладкий тренд (или сигнал) соответствует низким частотам. Поэтому, чтобы сгладить ряд, нужен фильтр, у которого АЧХ на низких частотах большая, а на высоких --- маленькая.  У нас есть подозрение, что скользящее среднее должно быть как раз таким фильтром. Посмотрим на него с этой точки зрения.

\section{AЧХ фильтра скользящего среднего, зависимость от длины окна}

Скользящее среднее --- частный случай линейного фильтра. Оно имеет один параметр $M$ --- ширина окна (порядок скользящего среднего) и коэффициенты (импульсную характеристику), равные $1/M$. Результат фильтра выглядит как среднее арифметическое $\sum_{i=1}^M x_{n-i}/M$, но с каким временем этот результата синхронизировать --- это отдельный разговор. При нечетном $M$ стандартный вариант --- синхронизация с серединой.
Про это поговорим позднее. Так как АЧХ зависит только от импульсной характеристики, то сейчас это не важно.


Характеристики фильтра:
\begin{itemize}
	\item FIR: $h_i = 1/M, i = 0, \dots, M-1$;
	\item $A_{\Phi}(\omega) = \frac{\sin(M\pi\omega)}{M\sin(\pi \omega)}$, $\omega \in [0,0.5]$.
\end{itemize}

//Можно нарисовать при разных $M$ АЧХ и результаты применения к шуму.

Видно, что чем больше $M$, тем быстрее АЧХ убывает (со скоростью $1/M$).

Отлично, мы это и хотели.

Но виден еще и дополнительный эффект --- АЧХ равна нулю в точках $k/M$.
Таким образом, скользящее среднее подавляет частоты периодик, которые имеют период, делящий длину окна нацело.

АЧХ скользящего среднего с длиной окна $M=12$ (для усиления подавления шума можно взять и $M=24, 36, 48 ,...$) для ряда, имеющего сезонность с периодом 12:

\begin{figure}[H]
	\center{\includegraphics[width=280pt, height=190pt]{maach.png}}
	\caption{АЧХ, $M = 12$}
\end{figure}

\section{АЧХ фильтра перехода к разностям (дифференцирования)}
Одной из стандартных операций, применяемых к временным рядам, является переход к последовательным разностям.
Фильтр выглядит следующим образом:
\begin{equation*}
y_n =x_n - x_{n-1},
\end{equation*}
т.е. импульсная характеристика равна равна $(1, -1)$.

Этот фильтр используется для устранения линейного тренда. Действительно, если был тренд $x_n = an+b$, то после применения фильтра получим $y_n \equiv a$. Однако, анализ АЧХ показывает, какую плату мы за это заплатим.

АЧХ такого фильтра:
\begin{figure}[H]
	\center{\includegraphics[width=280pt, height=190pt]{afcdiff.png}}
	\caption{АЧХ фильтра перехода к разностям}
\end{figure}

Действие этого фильтра обратно скользящему среднему: будут подавлены низкие частоты, полностью должна уйти константа, так как значение АЧХ в нулевой частоте равно 0 (что можно было предположить из вида фильтра --- он напоминает формулу численного дифференцирования и поэтому переход к разностям часто так и называется дифференцированием). Таким образом, если ряд был суммой линейного тренда, периодической компоненты и шума, то тренд после дифференцирования действительно превращается в константу, но одновременно увеличивается шум (его высокочастотная часть) и даже возможно, что периодическая компонента перестанет быть видима на фоне шума.

//Замечание. Для броуновского движения дифференцирование справляется со `случайным трендом' в том смысле, что броуновское движение (нестационарный процесс) превращается в белый шум (стационарный процесс).

\section{Связь между периодограммами ряда до и после применения фильтра}
//Может, перенести этот подраздел в начало, сразу после введения АЧХ?

Подытожим то, что ранее рассмотрели теоретически и на примерах.

Так как действие фильтра приводит к умножение амплитуды косинуса на значение АЧХ, периодограмма результата применения фильтра равна периодограмме исходного ряда, умноженной на квадрат АЧХ.

Рассмотрим периодограмму ряда без применения какого--либо фильтра (в т.ч. опция \texttt{detrend=FALSE}):
\begin{figure}[H]
	\center{\includegraphics[width=280pt, height=190pt]{rawper.png}}
	\caption{Периодограмма ряда, detrend = FALSE}
\end{figure}  \label{rawper}

Видим большой вклад низких частот, то есть тренда, на фоне которого просто только проглядывается вклад периодики (сезонности). Применим к ряду фильтр скользящего среднего с $M = 12$, вычтем полученное из исходного ряда и для получившегося остатка построим периодограмму:

\begin{figure}[H]
	\center{\includegraphics[width=280pt, height=190pt]{ma12per.png}}
	\caption{Периодограмма остатка после вычитания результата применения фильтра, detrend = FALSE}
\end{figure}

Воздействие тренда полностью убрано, частоты периодик видны куда явнее.

Построим периодограмму компоненты, непосредственно получившейся в результате сглаживания:

\begin{figure}[H]
	\center{\includegraphics[width=280pt, height=190pt]{ma12perraw.png}}
	\caption{Периодограмма фильтра, detrend = FALSE}
\end{figure}

Здесь наоборот, остались только низкие частоты (тренд), все остальные больше не видны.

P.S. Нужно заменить пример, чтобы тренд на периодограммах не забивал периодику.


\section{Что такое запаздывание и отчего оно может возникать (на примере скользящего среднего)?}

Мы уже упоминали, что результат применения фильтра можно соотносить с разными моментами во времени. Обсудим это более конкретно на примере скользящего среднего.

Пусть $M = 2k + 1$ --- нечетное. Вот есть у нас среднее арифметическое  $\frac{1}{M} \frac{1}{M} \sum_{i = -k}^{k}x_{n-i}$.

Есть два вполне осмысленных варианта: $y_n^{mid} = frac{1}{M} \frac{1}{M} \sum_{i = -k}^{k}x_{n-i}$ и
$y_{n+k}^{last} = frac{1}{M} \frac{1}{M} \sum_{i = -k}^{k}x_{n-i}$.

В первом случае легко увидеть, что линейная функция остается без изменения:
$y_n^{mid} = x_n$ при $x_n = an + b$, $n = k+1,\ldots,n-k$ (говорят, что нет смещения во времени). Обратите внимание, что последние точки не описываются этим фильтром. Также (на самом деле, это фактически то же самое утверждение), этот фильтр не является причинным (causal), так как заглядывает в будущее на $k$ точек.

//Наверно, тут можно выписать ФЧХ, но я ней не разбиралась, как она выглядит.

Во втором случае фильтр получается причинным (causal), однако очевидно, что он запаздывает:
$y_{n}^{last} = y_{n-k}^{mid} = a(n-k)+b$.

Сравним $y_n^{mid}$ и $y_n^{last}$ на примере.

\begin{figure}[H]
	\center{\includegraphics[width=450pt, height=350pt]{madelay.png}}
	\caption{MA, M = 12, T = 12}
\end{figure}

Видно, что причинный фильтр повторяет обычное скользящее среднее с запаздыванием (запаздывание равно $M/2$).
(//ничего тут не видно, нужен пример лучше)

\medskip
Если $M=2k$ четное, то сделать скользящее среднее несмещенным по времени невозможно. С другой стороны, четное $M$ очень нужно, например, чтобы убрать сезонность с периодом 12 (в данных по месяцам).

Оказывается, можно слегка изменить коэффициенты фильтра, не испортив его свойств.

Определим
\begin{equation*}
 z_n = \frac{1}{M} \sum_{i = -k}^{k-1}x_{n-i}.
\end{equation*}
Теперь применим фильтр порядка $2$ к полученному ряду:
\begin{equation*}
y_n = \frac{z_{n-1} + z_n}{2}.
\end{equation*}

Перепишем все через значения исходного ряда:
\begin{equation*}
y_n = \frac{x_{n-k} + x_{n+k}}{2M} + \frac{1}{M} \sum_{i = -k}^{k-1}x_{n-i}.
\end{equation*}

Теперь окно стало симметричным относительно $n$. Например, для устранения сезонности получим
фильтр с коэффициентами 1/24, потом 11 по 1/12 и в конце снова 1/24.


\textbf{Далее идет дополнительный материал.}

\section{Фильтр как оценка сингнала}

Посмотрим на фильтры с другой стороны (не с частотной). С одной стороны, сглаживание можно рассматривать как удаление высокочастотных составляющих. С другой стороны, если мы наблюдаем зашумленный тренд/сигнал, то хочется удалить шум и оставить только сигнал. Задачи очень похожие, но разница есть.

Рассмотрим последовательность следующего вида: $x_n = s_n + \epsilon_n$, причем $\mathbb{E}\epsilon_n = 0,$ $\mathbb{D}\epsilon_n = \sigma^2,$ $\epsilon_i$ --- независимы. Рассмотрим следующий линейный фильтр:
\begin{equation*}
y_n = \sum_{i = -r_1}^{r_2} h_i x_{n-i}.
\end{equation*}

Итак, посмотрим на фильтры с точки зрения того, как результат фильтрации оценивает сигнал.
Как обычно, точность оценки измеряется с помощью\\ MSE = дисперсия + (смещение в квадрате).

Рассмотрим слагаемые по-отдельности.

\subsection{Дисперсия}

Итак, рассмотрим оценку сигнала $\hat{s}_n = \sum_{i = -r_1}^{r_2} h_i x_{n-i}$. Посчитаем дисперсию этой оценки:
\begin{equation*}
\mathbb{D}\hat{s}_n = \mathbb{D} \sum_{i = -r_1}^{r_2} h_i (s_i + \epsilon_i) = \mathbb{D} \sum_{i} h_i \epsilon_i = \sum_{i} h^2_i \sigma^2 = \sigma^2 \sum_{i} h^2_i.
\end{equation*}
Итак, чтобы минимизировать дисперсию, нужно требовать $\sum_{i} h^2_i = ||\mathsf{h}||^2 \rightarrow \min$.

Для скользящего среднего с шириной окна $M$ $\mathbb{D}\hat{s}_n = \frac{\sigma^2}{M}$, т.е. чем больше окно, тем меньше дисперсия у результата.

Если предположить, что для сигнала выполняется следующее: $s_n = \sum_{i = -r_1}^{r_2} h_i s_i$, т.е. фильтр, примененный к сигналу, его не меняет, то смещение равно нулю ($\mathbb{E}\hat{s}_n = s_n$) и результат полностью определяется дисперсией. (Но даже в этом случае брать большую ширину окна может быть плохо для конечного ряда, так как слишком много крайних точек фильтром не будет описываться.) Вообще, несмещенность может быть довольно ограничительным предположением. Мы видели, что скользящее среднее обладает таким свойством (только?) для линейного сигнала.

\subsection{Смещение, роль второй производной}

%//Этот раздел сложен тем, что приходится переходить к непрерывному времени. Поэтому я и думаю, что этот раздел не включать, хотя концептуально раздел важный. Но для 3 семестра можно обойтись без концепций. Во всяком случае, пришлые магистры это не смогли понять.

Рассмотрим непрерывный аналог фильтрации, примененный к сигналу:
\begin{equation*}
y(a)=\int_{-\delta}^{\delta} s(a+x) w(x) dx,
\end{equation*}
где $w(x)$ --- весовая функция, причем $\int_{-\delta}^{\delta} w(x) d x=1$ (веса нормированы) и $\int_{-\delta}^{\delta} x w(x) d x=0$ (например, функция $w(x)$ симметричная). Здесь $\delta$ вместо ширины окна $M$, а весовая функция $w$ вместо коэффициентов $h_i$.

Под интегралом разложим функцию $s$ в ряд Тейлора (предполагаем, что $s$ --- гладкая):
\begin{equation*}
y(a) \approx s(a) \times 1+s^{\prime}(a) \times 0+\frac{s^{\prime \prime}(a)}{2} \int_{-\delta}^{\delta} x^{2} w(x) d x.
\end{equation*}
Таким образом, смещение $y(a) - s(a) \approx \frac{s^{\prime \prime}(a)}{2} \int_{-\delta}^{\delta} x^{2} w(x) d x$.

Если скользящее среднее с равными весами, то $w(x) = \frac{1}{2\delta}$ и
\begin{equation*}
y(a) \approx s(a) + \frac{s^{\prime \prime}(a)}{4\delta} \int_{-\delta}^{\delta} x^{2} d x = s(a) + \frac{s^{\prime \prime}(a) \delta^2}{6},
\end{equation*}
то есть смещение зависит от второй производной. Знак смещения зависит, соответственно, от знака второй производной, то есть от характера перегиба функции $s$. Понятно, что такой фильтр не имеет смысла, если вторая производная  большая (и $\delta$ недостаточно маленькое).

Пример.
<Картинка с косинусом и небольшой шириной окна, где видно, что на максимумах (вторая производная отрицательная) результат сглаживания меньше, а на минимумах больше.>

Таким образом, как обычно имеет trade-off между смещением и дисперсией при выборе ширины окна. 