\chapter{Лекция 2. Частотный анализ. Периодограмма}

Вообще, всегда интересуют изменения во времени. Собственно, понимание этих изменений --- это и есть анализ временных рядов.

Изменения не обязательно регулярные и их сложно описывать. Гораздо удобнее свести нерегулярные колебания к сумме регулярных.

А что такое регулярные колебания? Самые простые  --- это так называемые гармоники, т.е. синусы и косинусы.

В общем виде это косинус с периодом $T$.
$h_n = A\cos(2\pi n/T + \phi) = A\cos(2\pi \omega n + \phi)$, $n = 1, \ldots,N$.

Терминология:
$T$ ---период, $\omega$ --- частота, $A$ --- амплитуда, $\phi$ --- фаза. С помощью фазы можно синус превращать в косинус и наоборот: $\sin(x+\pi/2) = \cos(x)$. Поэтому часто называют такую компоненту $A\cos(2\pi \omega n + \phi)$ гармоникой.

Почему тут $T$ --- это период?

Период --- понятно, что такое, это число точек, через которое значения временного ряда повторяются.

Частота $\omega = 1/T$ --- обратная величина. Чем больше период, тем реже точки повторяются. И наоборот.

Для гармоники понятие частоты можно обобщить на случай, когда $T = 1/\omega$ не обязательно целое. Будем это использовать.

Однако, на частоту нужно наложить естественные ограничения: $0\le\omega\le 0.5$.
$0$ соответствует особому случаю, когда ряд --- константа, так как $p_n = \cos(0)=1$. $0.5$ соответствует другому особому случаю, когда ряда --- `пила', так как $p_n = \cos(\pi n)= (-1)^n$.

Колебаться чаще, чем с частотой 0.5 (период 2) ряд не может.

Можно рассмотреть еще более простые элементы --- синусы и косинусы без фазы, воспользовавшись соотношением
$A\cos(2\pi \omega n + \phi) = C \cos( 2\pi n \omega) + S \sin( 2\pi n \omega)$, где $A^2 = C^2+S^2$, $\phi = \mathrm{arctan}(...)$.

Итак, рассмотрим разложение Фурье, которое сводит произвольные колебания к сумме гармонических.

\section{Периодограмма временного ряда}
Пусть $\mathsf{X} = (x_1,\ldots,x_N)$ --- временной ряд длины $N$. Рассмотрим ортогональный тригонометрический базис, состоящий из
векторов $\left(\cos{2\pi n\frac{k}{N}},\ n=1,\ldots,N\right)^\mathrm{T}$ и $\left(\sin{2\pi n\frac{k}{N}},\ n=1,\ldots,N\right)^\mathrm{T}$, при $k=0,\ldots, \Big\lfloor \frac{N}{2} \Big\rfloor$. При $k=0$ вектора c $\sin(0)$ нет, он нулевой, а $\cos(0) = 1$. А если $N$ четное, то нет и вектора c $\sin(\pi n) = 0$ при $k=N/2$, а $\cos(\pi n) = (-1)^n$.
%:
%$$\bigg\{ 1, \sin{ \Big( 2\pi\frac{x}{N}\cdot1 \Big) }, \cos{ \Big( 2\pi\frac{x}{N} \cdot 1 \Big) }, \ldots, \sin{ \Big( 2\pi\frac{x}{N} \cdot \Big\lfloor \frac{N}{2} \Big\rfloor \Big) }, \cos{ \Big( 2\pi\frac{x}{N} \cdot  \Big\lfloor \frac{N}{2} \Big\rfloor  \Big)} \bigg\},\ x \in Z$$

Размер базиса равен $N$. Для $N = 2m + 1$ получим размер $1 + 2 \lfloor \frac{2m + 1}{2} \rfloor = 1 + 2m = N$. Для $N = 2m$ получим $1 + 2 \lfloor \frac{2m}{2} \rfloor = 1 + 2m = N + 1$, но последний синус будет нулевым, поэтому размер базиса равен $N$.

%Нам интересно разложить функцию ряда по этому базису, чтобы определить влияние конкретных частот на значения ряда.
%Пусть $$f: \big\{1, \ldots, N \big\} \rightarrow \mathbb{R}$$ функция, которая задаёт наш ряд. Нам известны значения этой функции, и мы хотим получить представление:

Итак, мы хотим получить представление
$$x_n = C_0 + \sum_{k=1}^{\lfloor \frac{N}{2} \rfloor}\{C_k \cdot \cos{\Big( 2\pi n \frac{k}{N} \Big)} + S_k \cdot \sin{\Big(2\pi n\frac{k}{N} \Big)}\},$$
где $n =1, \ldots, N$. Это называется \emph{разложением Фурье} по тригонометическому базису.
Эквивалентное представление разложения Фурье:
$$x_n = A_0 + \sum_{k=1}^{\lfloor \frac{N}{2} \rfloor} A_k \cos\Big( 2\pi n \frac{k}{N}+\phi_k \Big),$$
где $A_k^2 = C_k^2 + S_k^2$, $A_0=c_0$.

Понятно, что по коэффициентам $A_k$ можно понять, как ведет себя ряд.

Можно ввести функцию от частоты, заданную на решетке, она называется \emph{периодограммой ряда}:
$$\Pi\Big( \frac{k}{N} \Big) =\frac{N}{2}\begin{cases} 2A_0^2 & \text{if k = 0} \\ 2A_\frac{N}{2}^2 & \text{if N is even and } k=\frac{N}{2} \\ A_k^2 & \text{otherwise}\end{cases}$$
Объяснение того, что на крайних частотах коэффициент другой, состоит в том, что квадраты норм этих косинусов в два раза больше.

 У периодограммы временного ряда есть разные нормировки. В частности, часто нет коэффициента $N$. В данном случае нормировка такая, чтобы квадрат евклидовой нормы временного ряда был равен сумме значений периодограммы.

 На графиках частот на $N$ не умножают. Тогда сумма значений периодограммы будет равна средней сумме квадратов значений ряда. Мы будет рассматривать именно такой вариант.

 Давайте научимся `читать' периодограммы на основе ее графика. Сначала будем по ряду  смотреть, какая у него периодограмма. Разобрав это, сможем наоборот по периодограмме понимать, какой ряд.

%В \texttt{R} периодограмму можно построить с помощью функции \texttt{spec.pgram}.
%, там нет коэффициента $N$, поэтому сумма равна средней суммы квадратов элементов ряда (как квадрат второй нормы в АГК).

\section{Периодическая компонента}

\subsection{Одна гармоника}

Пусть $x_n = A\cos(2\pi\omega n +\phi)$, $0<\omega\le 0.5$.

Казалось бы, в разложении Фурье только одно ненулевое слагаемое, но (!) это так только если частота попадает в решетку $k/N$ ($N\omega$ --- целое; по другому --- длина ряда кратна периоду). Тогда периодограмма выглядит так:

\begin{figure}[H]
	\center{\includegraphics[width=280pt, height=190pt]{p1.png}}
	\caption{Периодограмма без растекания частоты}
\end{figure}

Имеем одно ненулевое значение в точке $\omega = k_0/N$, значение периодограммы $A^2$.

Если длина ряда не будет кратна периоду, то получим так называемое растекание частоты (frequency leakage).

%Для примера рассмотрим ряд длиной $105$ точек: $y_i = \cos(\frac{2\pi x_i}{10})$. Построим его периодограмму:

\begin{figure}[H]
	\center{\includegraphics[width=280pt, height=190pt]{p2.png}}
	\caption{Периодограмма исходного ряда}
\end{figure}

Поэтому, если есть возможность, то либо добавляют нули к ряду, что длина ряда делилась на период, либо удалют точки из начала ряда (лучше из начала, так как последних точек жалко). Конечно, так можно сделать, только если период известен (например, сезонность).

\subsection{Произвольная периодическая компонента}

Можно показать, что произвольная периодическая компонента с (целым) периодом $T$ является суммой гармоник с частотами $k/T$ (если $N$ кратно периоду), так как ее разложение Фурье сводится к разложению Фурье одного периода длины $T$.

Это эквивалентно тому, что на периодограмме будут (вернее, могут быть) ненулевые значения в точках $k/T$.

\begin{figure}[H]
	\center{\includegraphics[width=280pt, height=190pt]{detrend.png}}
	\caption{Периодограмма периодического ряда}
\end{figure}

Пример: данные по месяцам и сезонное поведение. Получим сумму косинусов с периодами $12$, $6=12/2$, $4=12/3$, $3=12/4$, $2.4=12/5$, $2=12/6$.

Конечно, если длина ряда не кратна периоду, то мы получим растекание вокруг каждой из частот.

Замечание: для амплитудно-модулированной гармоники (когда период не постоянный, а медленно меняется) всегда будет растекание частоты.

\section{Тренд: периодограмма тренда}

Вообще, исходно периодограмма не предназначена для анализа тренда, так как тренд не периодический и при изменении длины ряда его разложение в сумму гармоник может сильно меняться.

Однако, при фиксированной длине ряда, вполне можно рассматривать приближение тренда суммой гармоник с низкими (маленькими) частотами.

Определение тренда как медленно-меняющейся компоненты (вторая производная небольшая) согласуется с этим.
Действительно, во второй производной появляется коэффициент $\omega^2$, т.е. чем больше частота, тем больше вторая производная.

Итак, в периодограмме тренду соответствуют низкие частоты.

\begin{figure}[H]
	\center{\includegraphics[width=280pt, height=190pt]{trend.png}}
	\caption{Периодограмма тренда}
\end{figure}

А если в ряде есть и тренд, и периодика, то получим такую картинку: TODO.

Отсюда видно, что такое низкие частоты --- как минимум, они должны быть меньше, чем частота периодической компоненты.

Замечание. Если тренд большой по сравнению с периодикой, то на графике пики от периодики не будут видны.
Есть два способа борьбы с этим: либо рисование периодограммы в логарифмической шкале по оси Y, либо сначала вычитание тренд (имеется в виду линейный тренд) и потом рисование периодограммы остатка (обычно соотв. параметрназывается DETREND).

\section{Шум и его периодограмма}
Шум --- случайная составляющая временного ряда (например, стационарный процесс). Шум в данных может возникнуть из-за погрешности измерений или влияния случайных посторонних факторов.

$x_n = s_n + \epsilon_n$, $\mathbb{E}\varepsilon_n = 0$.

Не будем давать строгое определение стационарного случайного процесса. Важно понимать, что стационарность означает, что свойства шума не меняются во времени.

Периодограмма стационарного случайного процесса --- естественно, случайный набор чисел. Случ.процесс раскладывается по всем частотам.

Вид шума характеризуется математическим ожиданием периодограммы, т.е. тем, каков средний вклад тех или иных частот.

Если средний вклад всех частот одинаковый, то шум называется белым.  Это справедливо для случайного процесса с нулевым математическим ожиданием, постоянной дисперсией и нулевой корреляцией между $\xi_i$ и $\xi_j$, $i\ne j$. У красного шума чем меньше (ниже) частота,тем больше ее вклад.

Периодограмма белого шума выглядит следующим образом:

\begin{figure}[H]
	\center{\includegraphics[width=270pt, height=190pt]{whitenoise.png}}
	\caption{Периодограмма белого шума}
\end{figure}

Свойство периодограммы белого шума: значение периодограммы имеет экспоненциальное распределение с одним и тем же средним.  Почему важно, что экспоненциальное: у экспоненциального распределения длинный хвост, т.е. часто встречаются большие значения. Поэтому периодограмма такая 'лохматая'.
Также это объясняет, почему иногда большой случайный пик от шума можно принять за гармонику.

Теперь можем пояснить, откуда такие названия.
Ось частот можно интерпретировать и для цветовой гаммы (связано с длиной волны --- больше длина волны, т.е. больше период и меньше частота). Каждому цвету соответствует свой набор частот с разной интенсивностью. Например, белый цвет состоит из смеси всех цветов (всех волн) одинаковой интенсивности.
В красном цвете больше низких частот.

Другая интерпретация оси частот звуковая. Звуки также можно рассматривать как наборы звуковых волн разной частоты. Низкие звуки соответствуют низким частотам, высокие - высоким.

\medskip
Пример периодограммы ряда с трендом, периодикой и шумом (ТОDO).

Заметим следующее. Средний квадрат значений белого шума (рассматриваем частный случай) стремится к его дисперсии, т.е. к константе. Одновременно, средний квадрат значений белого шума равен сумме значений периодограммы ()мы рассматриваем такую нормировку).
Но при увеличении длины ряда число слагаемых (число узлов решетки с шагом $1/N$) увеличивается, поэтому средние значения периодограммы шума уменьшаются (и стремятся к нулю).
Значение же пика для гармоники не меняется (без растекания). Поэтому чем длиннее ряд, тем проще в нем увидеть периодики.

Задание по лекции 2 может быть таким: есть графики рядов и есть графики периодограмм. Нужно поставить их в пары. 